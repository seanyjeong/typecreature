<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:TypingTamagotchi.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="300"
        x:Class="TypingTamagotchi.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Typing Tamagotchi"
        Width="400" Height="300"
        WindowStartupLocation="CenterScreen">

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid RowDefinitions="Auto,*">
        <!-- 업데이트 알림 (상단) -->
        <Border Grid.Row="0"
                IsVisible="{Binding IsUpdateAvailable}"
                Background="#4CAF50"
                Padding="10,8">
            <Grid ColumnDefinitions="*,Auto,Auto">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="새 버전이 있습니다!"
                               Foreground="White"
                               VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding UpdateVersion, StringFormat='v{0}'}"
                               Foreground="White"
                               FontWeight="Bold"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- 다운로드 중 -->
                <StackPanel Grid.Column="1"
                            Orientation="Horizontal"
                            Spacing="10"
                            IsVisible="{Binding IsDownloading}">
                    <ProgressBar Value="{Binding DownloadProgress}"
                                 Minimum="0" Maximum="100"
                                 Width="100" Height="16"/>
                    <TextBlock Text="{Binding DownloadProgress, StringFormat='{}{0}%'}"
                               Foreground="White"
                               VerticalAlignment="Center"/>
                </StackPanel>

                <!-- 업데이트 준비 완료 -->
                <Button Grid.Column="1"
                        Content="재시작"
                        Command="{Binding ApplyUpdateCommand}"
                        IsVisible="{Binding IsUpdateReady}"
                        Background="White"
                        Foreground="#4CAF50"
                        Padding="15,5"
                        Margin="10,0"/>

                <!-- 다운로드 버튼 -->
                <Button Grid.Column="1"
                        Content="업데이트"
                        Command="{Binding DownloadUpdateCommand}"
                        IsVisible="{Binding !IsDownloading}"
                        Background="White"
                        Foreground="#4CAF50"
                        Padding="15,5"
                        Margin="10,0">
                    <Button.IsVisible>
                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                            <Binding Path="!IsDownloading"/>
                            <Binding Path="!IsUpdateReady"/>
                        </MultiBinding>
                    </Button.IsVisible>
                </Button>

                <!-- 닫기 -->
                <Button Grid.Column="2"
                        Content="X"
                        Command="{Binding DismissUpdateCommand}"
                        Background="Transparent"
                        Foreground="White"
                        Padding="5,0"/>
            </Grid>
        </Border>

        <!-- 메인 화면 -->
        <StackPanel Grid.Row="1" VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20">
            <!-- 알 이름 -->
            <TextBlock Text="{Binding EggName}"
                       FontSize="24"
                       FontWeight="Bold"
                       HorizontalAlignment="Center"/>

            <!-- 알 이미지 (placeholder) -->
            <Border Width="100" Height="100"
                    Background="#FFE4B5"
                    CornerRadius="50"
                    HorizontalAlignment="Center">
                <TextBlock Text="&#x1F95A;"
                           FontSize="48"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center"/>
            </Border>

            <!-- 진행도 -->
            <StackPanel Spacing="5">
                <ProgressBar Value="{Binding Progress}"
                             Minimum="0" Maximum="1"
                             Width="250" Height="20"/>
                <TextBlock Text="{Binding ProgressText}"
                           HorizontalAlignment="Center"/>
            </StackPanel>

            <!-- 수집 현황 (클릭하면 도감 열기) -->
            <Button Command="{Binding OpenCollectionCommand}"
                    HorizontalAlignment="Center"
                    Background="Transparent"
                    BorderThickness="0"
                    Cursor="Hand">
                <TextBlock Text="{Binding CollectionStatus, StringFormat='수집: {0}'}"
                           Foreground="Gray"
                           TextDecorations="Underline"/>
            </Button>

            <!-- 미니 위젯 토글 -->
            <Button Command="{Binding ToggleWidgetCommand}"
                    HorizontalAlignment="Center"
                    Padding="15,5"
                    Margin="0,5,0,0">
                <TextBlock Text="{Binding IsWidgetVisible, Converter={x:Static vm:WidgetButtonTextConverter.Instance}}"/>
            </Button>
        </StackPanel>

        <!-- 부화 팝업 -->
        <Border Grid.RowSpan="2"
                IsVisible="{Binding IsHatchPopupVisible}"
                Background="#80000000"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Border Background="White"
                    CornerRadius="10"
                    Padding="30"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    MinWidth="300">
                <StackPanel Spacing="15">
                    <TextBlock Text="부화!"
                               FontSize="24"
                               FontWeight="Bold"
                               HorizontalAlignment="Center"/>

                    <!-- 크리처 이미지 -->
                    <Border Width="80" Height="80"
                            Background="#E8F5E9"
                            CornerRadius="10"
                            HorizontalAlignment="Center"
                            ClipToBounds="True">
                        <Image Source="{Binding HatchedCreature.SpritePath, Converter={x:Static vm:SpritePathToImageConverter.Instance}}"
                               Width="72" Height="72"
                               Stretch="Uniform"/>
                    </Border>

                    <TextBlock Text="{Binding HatchedCreature.Name}"
                               FontSize="20"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"/>

                    <TextBlock Text="{Binding HatchedCreature.Rarity}"
                               HorizontalAlignment="Center"
                               Foreground="Purple"/>

                    <TextBlock Text="{Binding HatchedCreature.Description}"
                               HorizontalAlignment="Center"
                               Foreground="Gray"
                               TextWrapping="Wrap"/>

                    <Button Content="확인"
                            Command="{Binding CloseHatchPopupCommand}"
                            HorizontalAlignment="Center"
                            Padding="30,10"/>
                </StackPanel>
            </Border>
        </Border>

        <!-- 변경 로그 팝업 (업데이트 후 첫 실행) -->
        <Border Grid.RowSpan="2"
                IsVisible="{Binding IsChangelogVisible}"
                Background="#80000000"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Border Background="White"
                    CornerRadius="12"
                    Padding="25"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    MinWidth="320"
                    MaxWidth="380">
                <StackPanel Spacing="15">
                    <!-- 헤더 -->
                    <StackPanel Spacing="5">
                        <TextBlock Text="업데이트 완료!"
                                   FontSize="22"
                                   FontWeight="Bold"
                                   HorizontalAlignment="Center"
                                   Foreground="#4CAF50"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="10">
                            <TextBlock Text="{Binding ChangelogVersion, StringFormat='v{0}'}"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="#666"/>
                            <TextBlock Text="{Binding ChangelogDate}"
                                       FontSize="14"
                                       Foreground="#999"
                                       VerticalAlignment="Center"/>
                        </StackPanel>
                        <TextBlock Text="{Binding ChangelogTitle}"
                                   FontSize="16"
                                   HorizontalAlignment="Center"
                                   Foreground="#333"/>
                    </StackPanel>

                    <!-- 변경 내용 리스트 -->
                    <Border Background="#F5F5F5"
                            CornerRadius="8"
                            Padding="15"
                            MaxHeight="200">
                        <ScrollViewer>
                            <ItemsControl ItemsSource="{Binding ChangelogItems}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4">
                                            <!-- 타입별 아이콘 -->
                                            <Border Width="22" Height="22" CornerRadius="11">
                                                <Border.Background>
                                                    <MultiBinding Converter="{x:Static vm:ChangeTypeToColorConverter.Instance}">
                                                        <Binding Path="Type"/>
                                                    </MultiBinding>
                                                </Border.Background>
                                                <TextBlock Text="{Binding Type, Converter={x:Static vm:ChangeTypeToIconConverter.Instance}}"
                                                           FontSize="12"
                                                           Foreground="White"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center"/>
                                            </Border>
                                            <TextBlock Text="{Binding Text}"
                                                       TextWrapping="Wrap"
                                                       VerticalAlignment="Center"
                                                       Foreground="#333"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Border>

                    <!-- 확인 버튼 -->
                    <Button Content="확인"
                            Command="{Binding CloseChangelogCommand}"
                            HorizontalAlignment="Center"
                            Padding="40,10"
                            Background="#4CAF50"
                            Foreground="White"/>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</Window>
